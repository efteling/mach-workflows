name: Build & Test (CI)

on:
  workflow_call:
    inputs:
      solution_name:
        type: string

permissions:
  contents: write
  deployments: write
  id-token: write    
   
jobs:     
  build-and-test:
    runs-on: ubuntu-latest
        
    steps:    
      - name: Checkout 🛒
        uses: actions/checkout@v3
      
      - name: Setup NuGet.exe for use with actions
        uses: NuGet/setup-nuget@v1.1.1          

      - name: RUN .NET Restore 🌱
        run: |
          dotnet restore ./src

      - name: Setup .NET 6 SDK ⚙️
        uses: actions/setup-dotnet@v2.1.0
        with:
          dotnet-version: 6.x    

      - name: Check for vulnerabilities (SNYK) 🔍
        uses: snyk/actions/dotnet@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --file=./src/${{ inputs.solution_name }} --policy-path=./src/.snyk --show-vulnerable-paths=a       
          
      - name: Build 🏗️
        run: dotnet build ./src/${{ inputs.solution_name }} --configuration Release --no-restore

      - name: Run tests
        run: dotnet test ./src/${{ inputs.solution_name }} --configuration Release --no-restore --no-build --verbosity normal          
        
    outputs:
      SNYK: ${{ env.artifact-build-info }}        
